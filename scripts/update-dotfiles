#!/bin/bash

set -euo pipefail

# Colors
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
BLUE=$(tput setaf 4)
RESET=$(tput sgr0)

info() { echo -e "${GREEN}➤ $1${RESET}"; }
error() { echo -e "${RED}✖ $1${RESET}" >&2; }

echo -e "${BLUE}
░█▀▄░█▀█░▀█▀░█▀▀░▀█▀░█░░░█▀▀░█▀▀░░░█░█░█▀█░█▀▄░█▀█░▀█▀░█▀▀
░█░█░█░█░░█░░█▀▀░░█░░█░░░█▀▀░▀▀█░░░█░█░█▀▀░█░█░█▀█░░█░░█▀▀
░▀▀░░▀▀▀░░▀░░▀▀▀░░▀░░▀▀▀░▀▀▀░▀▀▀░░░▀▀▀░▀░░░▀▀░░▀░▀░░▀░░▀▀▀
${RESET}"

# Backup current wallpaper setting
CURRENT_WALLPAPER=""
if [ -f "$HOME/.config/hypr/current_wallpaper" ]; then
    CURRENT_WALLPAPER=$(cat "$HOME/.config/hypr/current_wallpaper")
    info "Backing up current wallpaper: $CURRENT_WALLPAPER"
fi

# Create temporary directory
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"

info "Downloading latest dotfiles..."
if ! git clone https://github.com/SanBenito12/hyprdots.git; then
    error "Failed to clone repository."
    exit 1
fi

cd hyprdots

info "Updating configuration files..."
# Copy new configs, preserving user's wallpaper choice
rm -rf ./preview
cp -rf ./config/* ~/.config/ || error "Failed to copy configs"
chmod +x ~/.config/hypr/scripts/* ~/.config/eww/scripts/* || true

# Restore wallpaper preference if it existed
if [ -n "$CURRENT_WALLPAPER" ] && [ -f "$CURRENT_WALLPAPER" ]; then
    info "Restoring wallpaper: $CURRENT_WALLPAPER"
    ln -sf "$CURRENT_WALLPAPER" ~/.config/hypr/wallppr.png
    echo "$CURRENT_WALLPAPER" > ~/.config/hypr/current_wallpaper
else
    info "Setting default wallpaper..."
    ln -sf "$HOME/.config/hypr/wallpapers/Lines.png" "$HOME/.config/hypr/wallppr.png"
    echo "$HOME/.config/hypr/wallpapers/Lines.png" > "$HOME/.config/hypr/current_wallpaper"
fi

# Update scripts
info "Updating system scripts..."
cp -rf ./scripts ~/.config/ || error "Failed to copy scripts"
chmod +x ~/.config/scripts/* || true

# Restart services
info "Reloading components..."
if pgrep waybar >/dev/null 2>&1; then
    pkill waybar >/dev/null 2>&1 || true
fi
(waybar & disown) >/dev/null 2>&1 || true

if pgrep swww-daemon >/dev/null 2>&1; then
    bash ~/.config/hypr/scripts/restore_wallpaper.sh
fi

pgrep eww >/dev/null && killall eww && eww daemon >/dev/null 2>&1 && eww open-many stats desktopmusic >/dev/null 2>&1 || true

# Cleanup
cd "$HOME"
rm -rf "$TEMP_DIR"

info "✅ Dotfiles updated successfully!"